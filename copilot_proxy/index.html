<!doctype html>

<meta charset="UTF-8">
<title>FauxPilot</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css"
      integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/material-darker.min.css"
      integrity="sha512-2OhXH4Il3n2tHKwLLSDPhrkgnLBC+6lHGGQzSFi3chgVB6DJ/v6+nbx+XYO9CugQyHVF/8D/0k3Hx1eaUK2K9g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/lint/lint.min.css"
      integrity="sha512-jP1+o6s94WQS9boYeDP3Azh8ihI5BxGgBZNjkABhx05MqH5WuDzfzSnoPxGxVzWi/gxxVHZHvWkdRM6SMy5B0Q=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"
        integrity="sha512-Kpi2Sp2KpXM2S7aM0p+CwWhm8NuogI15GFPXCmgqAnFr5c86VBXuLEZu0IGBwGSdhhTW6148hP9KTcRMmrjuFQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/python/python.min.js"
        integrity="sha512-RT0AjIFvx/vuD2Ih9pmIOhlU+HNTpTHGMJ7TORv4oTT0yHqbz9BicxiBohrq84kjvpHnXtWg/wjG0kisHh4EOA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/javascript/javascript.min.js"
        integrity="sha512-I6CdJdruzGtvDyvdO4YsiAq+pkWf2efgd1ZUSK2FnM/u2VuRASPC7GowWQrWyjxCZn6CT89s3ddGI+be0Ak9Fg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/lint/lint.min.js"
        integrity="sha512-fzIkwQa9H8rjoDzpZ9sMOYhgaYwh9nKALWbE1m+7wpiry9PN5OyNcZ9LySotjEysolveRyv2C9pVJ+DbEuKtmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/lint/json-lint.min.js"
        integrity="sha512-40xVcCik6TlUiZadnRc6ZM0BN65s7F+C3K7eBqGRf8dmjKApjzoiT/GB1GJmdICOZbXjJCiTBbVlsIvFs8A/+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>
<style type=text/css>
    .code > .CodeMirror {
        float: left;
        width: 50%;
        border: 1px solid black;
    }

    .preview > .CodeMirror {
        width: 49%;
        position: absolute;
        display: initial;
        float: right;
        height: 602px;
        border: 1px solid black;
        border-left: 0;
    }

</style>
<article>
    <div style="display: flex; justify-content: space-between;">
        <h1>FauxPilot Playground</h1>
        <img src="https://pbs.twimg.com/media/FgZ99z3XEAAhp8a?format=jpg&name=medium"
             style="position: absolute;width: auto;height: 100px;right: 12px;" alt="logo"/>
    </div>
    <div style="display: flex; justify-content: space-between;">
        <p>Press Ctrl/Command + Enter to copy the suggested code</p>
        <p id="loading" style="width: 49.7%;padding-left: 10px;"></p>
    </div>
    <div class="code">
        <textarea id=code name=code></textarea>
    </div>
    <div class="preview">
        <textarea id=preview name=preview disabled></textarea>
    </div>
    <div class="code">
        <textarea id=config name=config></textarea>
    </div>
    <script>
        let delay;
        let calls = 0;
        const editorConfig = {
            mode: "python",
            theme: "material-darker",
            lineWrapping: true,
            lineNumbers: true,
            styleActiveLine: true,
            matchBrackets: true,
            indentUnit: 4,
            parserConfig: {'pythonVersion': 3, 'strictErrors': true},
        }
        let editor = CodeMirror.fromTextArea(document.getElementById('code'), editorConfig);
        let preview = CodeMirror.fromTextArea(document.getElementById('preview'), {
            ...editorConfig,
            readOnly: true,
        });
        let config = CodeMirror.fromTextArea(document.getElementById('config'), {
            mode: "application/json",
            lineNumbers: true,
            indentUnit: 4,
            lint: true,
        });
        let loading = document.getElementById('loading');

        editor.on("change", function () {
            calls++;
            clearTimeout(delay);
            delay = setTimeout(updatePreview, 300);
        });
        config.on("change", function () {
            calls++;
            clearTimeout(delay);
            delay = setTimeout(updatePreview, 300);
        });

        function getOpenAIConfig() {
            fetch("/v1/playground/get_config", {
                method: "GET",
                headers: {'Content-Type': 'application/json'},
            }).then(res => {
                res.json().then(json => {
                    config.setValue(JSON.stringify(json, null, 4));
                });
            });
        }

        function updatePreview() {
            loading.innerText = "Loading...";
            const currentCall = calls;
            let currentCode = editor.getValue();
            let configJSON = JSON.parse(config.getValue());
            if (currentCode.length === 0) {
                preview.setValue("")
                loading.innerText = "";
                return
            }
            if (currentCall < calls) {
                return
            }
            let timeStart = performance.now();
            fetch("/v1/playground", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({...configJSON, prompt: currentCode})
            }).then(res => {
                res.text().then(text => {
                    if (currentCall === calls) {
                        let timeEnd = performance.now();
                        preview.setValue(currentCode + text);
                        loading.innerText = `Returned completion in ${Math.round(timeEnd - timeStart)}ms`;
                    }
                });
            });
        }

        function bindKeys() {
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.code) {
                        case 'Enter':
                            editor.setValue(preview.getValue());
                            editor.setCursor(editor.lineCount(), 0);
                            break;
                    }
                }
            });
        }

        bindKeys()
        getOpenAIConfig();
        setTimeout(updatePreview, 300);
    </script>
</article>